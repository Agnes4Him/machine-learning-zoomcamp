name: ML Model CI Pipeline

on:
  push:
    branches:
    - main
    paths:
    - "capstone-project/server/Dockerfile"
    - "capstone-project/server/predict.py"
    - ".github/workflows/capstone-ci.yaml"
  workflow_dispatch:

env:
  IMAGE_NAME: energy-prediction-server
  IMAGE_TAG: ${{ github.sha }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # Python Setup
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r capstone-project/server/requirements.txt
        pip install pytest pytest-cov safety

    # Unit Tests + Coverage
    - name: Run unit tests
      working-directory: capstone-project
      run: |
        pytest --cov=server --cov-report=xml:coverage.xml --cov-report=term

    # Dependency Vulnerability Scan
    - name: Dependency check - Safety
      run: |
        safety scan --full-report || true         

    # SonarQube Scan - SAST
    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@v2
      with:
        projectBaseDir: capstone-project
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # SonarQube Quality Gate
    - name: SonarQube Quality Gate
      uses: sonarsource/sonarqube-quality-gate-action@v1
      with:
        # Path to report-task.txt generated by the Sonar scan
        scanMetadataReportFile: capstone-project/.scannerwork/report-task.txt
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # Docker Login
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ env.DOCKERHUB_TOKEN }}

    # Docker Build
    - name: Build Docker image
      working-directory: capstone-project/server
      run: |
        docker build \
          -t $DOCKERHUB_USERNAME/$IMAGE_NAME:$IMAGE_TAG \
          .

    # Smoke Test
    - name: Run smoke tests
      working-directory: capstone-project/server/scripts
      run: |
        chmod +x smoke-test.sh
        ./smoke-test.sh

    # Trivy Image Scan
    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: table
        exit-code: 1
        severity: CRITICAL,HIGH

    # Push Docker Image
    - name: Push Docker image
      run: |
        docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:$IMAGE_TAG

    # Update Kubernetes Manifest
    - name: Update Kubernetes manifest image tag
      working-directory: capstone-project/kubernetes
      run: |
        sed -i \
          "s|image: .*|image: $DOCKERHUB_USERNAME/$IMAGE_NAME:$IMAGE_TAG|" \
          eks/server/deployment.yaml \

        sed -i \
          "s|image: .*|image: $DOCKERHUB_USERNAME/$IMAGE_NAME:$IMAGE_TAG|" \
          local/server/deployment.yaml
    - name: Commit updated manifest
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add capstone-project/kubernetes/eks/server/deployment.yaml capstone-project/kubernetes/local/server/deployment.yaml
        git commit -m "Update image tag to ${{ github.sha }}" || echo "No changes"
        git push